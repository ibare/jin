<link rel="import" href="/lib/polymer/polymer.html">

<polymer-element name="jin-layout" attributes="">
  <template>
    <style>
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input[type=text] { border: 0; padding: 10px; width: 80%; margin-right: .5%; }
      form input[type=checkbox] { width: 9%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      pre { border-radius: 4px; padding: 6px; }
      .profile { width: 40px; margin-right: 10px; vertical-align: middle; border-radius: 20px; }
      li { font-size: 15px; }
    </style>
    <template id="chat-message">
      <h1>Okay</h1>
      <!-- <li><strong>{{msg.user}}</strong>1<span>{{msg.body}}</span> <u>{{msg.type}}</u></li> -->
    </template>
    <template id="code-message">
      <li><pre id="cid{{ cid }}" class="prettyprint linenums"><code class="lineNumbers">{{msg.body}}</code></pre>2</li>
    </template>

    <ul id="messages">
    </ul>
    <form>
      <input type="text" id="m" value="{{msg}}" autocomplete="off" />
      <input type="checkbox" id="c" on-click={{toogleLanguage}} />
      <input type="submit" value="Send" />
    </form>
  </template>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="/js/protocol.js"></script>
  <script>
    (function () {
      'use strict';
      Polymer({
        socket: io(),
        nickname: '',
        cid: 0,
        msg: '',
        chatMessages: [],

        applyHighlight: function() {
          $('#cid'+this.cid).each(function(i, block) {
            hljs.highlightBlock(block);
          });
        },

        toogleLanguage: function() {
          if(this.$.c.checked) {
            this.cid = Date.now();

            this.socket.emit('chat message', this.nickname+'#'+'/* code here ... */\n');
          } else {
            this.cid = 0;
          }
        },

        msgChanged: function() {
          var msg = Protocol.chat();

          if(this.msg[this.msg.length-1] == '~') {
            msg.type = Protocol.chat.MESSAGE;
            msg.username = this.nickname;
            msg.body = this.msg;

            this.socket.emit('chat message', msg);
            this.msg = '';
          }
        },

        ready: function() {
          var $scope = this;

          Protocol.defineMessage('chat', {
            username: String,
            type: ['MESSAGE','CODE'],
            cid: Number,
            body: String
          });

          this.nickname = prompt('이름이 뭐에요?');

          this.socket.on('chat message', function(msg){
            var chatTemplate = $scope.$['chat-message'];
            var codeTemplate = $scope.$['code-message'];
            var clone = document.importNode(chatTemplate.content, true);
            var type = !!$scope.cid ? Protocol.chat.CODE : Protocol.chat.MESSAGE;

            $scope.chatMessages.push({
              type: type,
              user: msg.username,
              body: msg.body
            });

            $scope.$.messages.appendChild(clone); // host

            if(!!this.cid) {
              $('#cid'+this.cid+' code').append(msg.body+'\n');

              applyHighlight();
            } else {
              $('#messages').append($('<li><img class="profile" src="'+msg.username+'">'+msg.body+'</li>'));
            }

          });
        }
      });
    })();
  </script>
</polymer-element>